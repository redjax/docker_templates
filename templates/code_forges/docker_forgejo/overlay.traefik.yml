---
networks:
  traefik_net: {}
    # driver: bridge
    # external: true


services:
  traefik:
    image: traefik:v3.3.3
    restart: unless-stopped
    network_mode: host
    command:
      - "--configFile=/etc/traefik/traefik_config.yml"
      - "--certificatesresolvers.myresolver.acme.dnschallenge=true"
      - "--certificatesresolvers.myresolver.acme.dnschallenge.provider=cloudflare"
    environment:
      TRAEFIK_ACME_EMAIL: ${TRAEFIK_ACME_EMAIL:-none@example.com}
      CLOUDFLARE_DNS_API_TOKEN: ${CF_API_TOKEN}
    volumes:
      - "${TRAEFIK_LETSENCRYPT_DIR:-./data/traefik/letsencrypt}:/letsencrypt"
      - ${TRAEFIK_CONFIG_FILE:-./config/traefik/traefik_config.yml}:/etc/traefik/traefik_config.yml:ro
      - ${TRAEFIK_DYNAMIC_CONFIG_FILE:-./config/traefik/dynamic_config.yml}:/etc/traefik/dynamic_config.yml:ro
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
    ports:
      - ${TRAEFIK_HTTP_PORT:-80}:80
      - ${TRAEFIK_HTTPS_PORT:-443}:443
    # networks:
    #   - traefik_net

  forgejo:
    environment:
      FORGEJO_DOMAIN: ${TRAEFIK_DOMAIN:-git.example.com}
    # networks:
    #   - traefik_net
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.forgejo.rule=Host(`${TRAEFIK_DOMAIN}`)"
      - "traefik.http.routers.forgejo.entrypoints=websecure"
      - "traefik.http.routers.forgejo.tls.certresolver=letsencrypt"
      - "traefik.http.services.forgejo.loadbalancer.server.port=3000"
